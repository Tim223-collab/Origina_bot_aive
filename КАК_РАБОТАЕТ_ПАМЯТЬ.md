# 🧠 Как работает память и база данных

## 📚 Архитектура

### 3 уровня хранения:

```
┌─────────────────────────────────────────────┐
│         1. КРАТКОСРОЧНАЯ ПАМЯТЬ             │
│    (conversations - история диалогов)       │
│         Хранится: 20 последних              │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│         2. ДОЛГОСРОЧНАЯ ПАМЯТЬ              │
│    (long_term_memory - важные факты)        │
│         Хранится: навсегда                  │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│         3. КОНТЕКСТ ДЛЯ ИИ                  │
│  (комбинация памяти + история + промпт)     │
└─────────────────────────────────────────────┘
```

---

## 💾 База данных (SQLite)

### Расположение:
```
data/bot.db
```

### 6 таблиц:

#### 1. **users** - пользователи
```sql
user_id (PRIMARY KEY)    - ID в Telegram
username                 - @username
first_name              - Имя
last_name               - Фамилия
created_at              - Когда зарегистрирован
last_active             - Последняя активность
settings                - Настройки (JSON)
```

#### 2. **conversations** - история диалогов ⭐
```sql
id (AUTOINCREMENT)      - Уникальный ID сообщения
user_id                 - Кто написал
role                    - "user" или "assistant"
content                 - Текст сообщения
timestamp               - Когда написано
```

**Что хранится:**
- Все твои сообщения (role = "user")
- Все ответы бота (role = "assistant")
- Порядок сообщений (по id)

**Как используется:**
```python
# Получить последние 20 сообщений для контекста
messages = await db.get_recent_messages(user_id, limit=20)

# Результат:
[
    {"role": "user", "content": "Привет!", "timestamp": "..."},
    {"role": "assistant", "content": "Привет! Как дела?", "timestamp": "..."},
    {"role": "user", "content": "Расскажи про Python", "timestamp": "..."},
    ...
]
```

#### 3. **long_term_memory** - долгосрочная память ⭐⭐⭐
```sql
id (AUTOINCREMENT)      - ID записи
user_id                 - Чья память
category                - Категория (personal, work, preferences, learning)
key                     - Ключ (название факта)
value                   - Значение
created_at              - Когда создано
updated_at              - Когда обновлено
UNIQUE(user_id, category, key)  - Один факт = одна запись
```

**Примеры данных:**
```
user_id | category    | key           | value
--------|-------------|---------------|------------------
123456  | personal    | день_рождения | 15.05.1990
123456  | personal    | город         | Київ
123456  | work        | проект        | telegram-bot
123456  | work        | дедлайн       | 31.12.2025
123456  | preferences | язык          | Python
123456  | preferences | кофе          | черный без сахара
123456  | learning    | тема          | Docker
```

**Команды:**
```
/remember personal день_рождения 15.05.1990
→ Сохраняет в БД

/recall
→ Показывает всю память

/recall personal
→ Показывает только категорию personal

/forget personal день_рождения
→ Удаляет из памяти
```

#### 4. **notes** - заметки
```sql
id (AUTOINCREMENT)      - ID заметки
user_id                 - Чья заметка
title                   - Заголовок (опционально)
content                 - Текст заметки
tags                    - Теги (JSON массив)
created_at              - Когда создана
updated_at              - Когда обновлена
```

#### 5. **work_stats** - статистика работы
```sql
id (AUTOINCREMENT)      - ID записи
user_id                 - Чья статистика
date                    - Дата
total_records           - Всего записей
total_sfs               - Успешных (SFS)
total_sch               - Проверенных (SCH)
workers_data            - Данные работников (JSON)
parsed_at               - Когда спарсено
```

#### 6. **reminders** - напоминания
```sql
id (AUTOINCREMENT)      - ID напоминания
user_id                 - Кому
text                    - Текст напоминания
remind_at               - Когда напомнить
created_at              - Когда создано
completed               - Выполнено? (0/1)
```

---

## 🔄 Как работает диалог с памятью

### Поток данных при сообщении:

```
1. ТЫ: "Привет! Как дела?"
   ↓
2. СОХРАНЕНИЕ: db.add_message(user_id, "user", "Привет! Как дела?")
   ↓
3. ЗАГРУЗКА КОНТЕКСТА:
   - Последние 20 сообщений из conversations
   - Вся долгосрочная память из long_term_memory
   ↓
4. ФОРМИРОВАНИЕ ПРОМПТА:
   system_prompt = """
   Ты личный ИИ-помощник...
   
   Что я знаю о пользователе:
   Personal: день_рождения - 15.05.1990, город - Київ
   Work: проект - telegram-bot, дедлайн - 31.12.2025
   Preferences: язык - Python, кофе - черный без сахара
   """
   ↓
5. ОТПРАВКА К DEEPSEEK API:
   messages = [
       {"role": "system", "content": system_prompt},
       {"role": "user", "content": "Предыдущее1"},
       {"role": "assistant", "content": "Ответ1"},
       {"role": "user", "content": "Предыдущее2"},
       {"role": "assistant", "content": "Ответ2"},
       {"role": "user", "content": "Привет! Как дела?"}
   ]
   ↓
6. ПОЛУЧЕНИЕ ОТВЕТА: "Привет! Отлично, спасибо!"
   ↓
7. СОХРАНЕНИЕ ОТВЕТА: db.add_message(user_id, "assistant", "Привет! Отлично, спасибо!")
   ↓
8. ОТПРАВКА ТЕБЕ В TELEGRAM
```

---

## 🧠 MemoryService - управление памятью

### Основные методы:

#### 1. **get_context_for_ai()** - подготовка контекста
```python
async def get_context_for_ai(user_id):
    # Получает все факты из long_term_memory
    memories = await db.recall(user_id)
    
    # Группирует по категориям
    # Формирует строку для системного промпта
    
    return """
    Что я знаю о пользователе:
    Personal: день_рождения - 15.05.1990, город - Київ
    Work: проект - telegram-bot
    Preferences: язык - Python
    """
```

#### 2. **remember_fact()** - сохранить факт
```python
await memory.remember_fact(
    user_id=123456,
    category="personal",
    key="день_рождения",
    value="15.05.1990"
)
```

#### 3. **recall_facts()** - получить факты
```python
facts = await memory.recall_facts(user_id, category="personal")

# Результат:
[
    {
        "category": "personal",
        "key": "день_рождения",
        "value": "15.05.1990",
        "created_at": "2025-10-26 20:00:00",
        "updated_at": "2025-10-26 20:00:00"
    },
    ...
]
```

---

## 📊 Примеры работы

### Пример 1: Сохранение и использование памяти

```
ТЫ: /remember personal город Київ
БОТ: ✅ Запомнил!
     📁 Категория: personal
     🔑 Ключ: город
     📝 Значение: Київ

[В БД сохранено:]
INSERT INTO long_term_memory
VALUES (349295048, 'personal', 'город', 'Київ')

---

ТЫ: Какая у меня погода?
БОТ загружает память → видит город: Київ
БОТ: [внутренне понимает твой город]
     Сейчас проверю погоду в Киеве...
```

### Пример 2: Контекст разговора

```
ТЫ: Расскажи про Python
БОТ: Python - язык программирования...

[Сохранено в conversations]

ТЫ: А какие библиотеки?
БОТ загружает последние 20 сообщений
    → видит что говорили про Python
    → отвечает в контексте
БОТ: Для Python есть много библиотек...
```

### Пример 3: Долгосрочная память через диалог

```
ТЫ: Я работаю над проектом telegram-bot с дедлайном 31 декабря

БОТ: Отлично! Успехов с проектом!

[Ты можешь сохранить вручную:]
ТЫ: /remember work проект telegram-bot
ТЫ: /remember work дедлайн 31.12.2025

---

[Через неделю:]
ТЫ: Как там с моим проектом?
БОТ загружает память → видит:
     - work.проект = telegram-bot
     - work.дедлайн = 31.12.2025
БОТ: Как продвигается telegram-bot? 
     До дедлайна 31 декабря осталось 2 месяца!
```

---

## 🎯 Преимущества такой архитектуры

### ✅ Краткосрочная память (conversations):
- Автоматическая - сохраняет всё
- Контекст последних 20 сообщений
- ИИ помнит о чем говорили недавно

### ✅ Долгосрочная память (long_term_memory):
- Ручная или авто - сохраняешь важное
- Бесконечное хранение
- Структурированная (категории + ключи)
- ИИ всегда знает важные факты о тебе

### ✅ Комбинация:
- ИИ помнит и контекст И важные факты
- Персонализированные ответы
- Можно удалять историю (/clear) но память остается
- База данных локальная - всё под контролем

---

## 🔧 Технические детали

### Асинхронность:
```python
# Все операции с БД асинхронные
async with aiosqlite.connect(db_path) as db:
    await db.execute("INSERT ...")
    await db.commit()
```

### Транзакции:
- Каждая операция в своей транзакции
- Автоматический commit
- Безопасно при ошибках

### Индексы:
- PRIMARY KEY автоматически индексируется
- UNIQUE(user_id, category, key) - быстрый поиск

### JSON хранение:
```python
# tags в notes хранятся как JSON
tags = ["работа", "важное"]
tags_str = json.dumps(tags)  # '["работа", "важное"]'

# При загрузке:
tags = json.loads(tags_str)  # ["работа", "важное"]
```

---

## 📁 Где хранится

```
data/
└── bot.db          # SQLite файл (~100 KB пустой)
```

### Можно открыть:
```bash
# SQLite browser
sqlite3 data/bot.db

# Запросы:
SELECT * FROM long_term_memory;
SELECT * FROM conversations LIMIT 10;
SELECT * FROM users;
```

---

## 💡 Советы по использованию

### 1. Сохраняй важное в долгосрочную память:
```
/remember personal интересы программирование, музыка
/remember work роль fullstack-разработчик
/remember preferences стиль минимализм
```

### 2. Используй категории:
- `personal` - личное (день рождения, город, увлечения)
- `work` - работа (проект, должность, команда)
- `preferences` - предпочтения (язык, редактор, стиль)
- `learning` - обучение (что изучаешь)

### 3. Очищай историю но не память:
```
/clear          # Очистит conversations, но память останется
/recall         # Покажет что бот помнит
```

### 4. Проверяй что запомнилось:
```
/recall         # Вся память
/recall work    # Только рабочее
```

---

## 🎓 Итого

**Память бота = двухуровневая:**
1. **Краткосрочная** (20 сообщений) - автоматическая
2. **Долгосрочная** (факты навсегда) - ручная

**База данных:**
- SQLite файл в `data/bot.db`
- 6 таблиц для разных данных
- Асинхронная работа через aiosqlite

**ИИ использует оба уровня:**
- Контекст последних сообщений
- + Важные факты о тебе
- = Персонализированные умные ответы

---

**Документация:** v1.2.0 🇺🇦

